/* Auto generated code
 *
 * Changes to this file may cause incorrect behavior and will be lost if
 * the code is regenerated
 */
{% for dep in dependencies %}import { {{", ".join(dep[0])}} } from "{{dep[1]}}";
{% endfor%}

export type {{class_name}}Value = {%- for arg in decl["tref"]["targs"] %} {{typeref(arg)}}{{" |" if not loop.last}}
  {%- endfor %};

export type {{class_name}}Like = {{class_name}} | {{class_name}}Value | {
  type: string;
  value: {%- for arg in decl["tref"]["targs"] %} {{typeref_like(arg)}}{{" |" if not loop.last}}
  {%- endfor %}
}

export class {{class_name}} {
  public value: {{class_name}}Value;

  constructor(
    value: {{class_name}}Like = {
      type: "{{"::".join(decl["tref"]["targs"][0]["name"])}}",
      value: undefined
    }
  ) {
    if (value instanceof {{class_name}}) {
      this.value = value.value;
    } else if ({%- for arg in decl["tref"]["targs"] %}value instanceof {{typeref(arg)}}{{" ||" if not loop.last}}
  {%- endfor %}) {
      this.value = value;
    } else {
      {%- for arg in decl["tref"]["targs"] %}{{"else " if loop.index > 1 }}if(value.type === "{{"::".join(arg["name"])}}") this.value = new {{typeref(arg)}}(value.value as {{typeref(arg)}}Like);
      {% endfor %}else throw new Error(`Unknown variant type ${value.type}`);
    }
  }

  serialize(blob?: VariableBlob): VariableBlob {
    const vb = blob || new VariableBlob(this.calcSerializedSize());
    let i: number;
    {%- for arg in decl["tref"]["targs"] %}{{"else " if loop.index > 1 }}if (this.value instanceof {{typeref(arg)}}) i = {{loop.index - 1}};
    {% endfor %}else throw new Error("Unknown variant type");
    vb.serialize(new VarInt(i));
    vb.serialize(this.value);
    if (!blob) vb.resetCursor();
    return vb;
  }

  static deserialize(vb: VariableBlob): {{class_name}} {
    const i = vb.deserialize(VarInt).toNumber();
    let value: {{class_name}}Value;
    {%- for arg in decl["tref"]["targs"] %}{{"else " if loop.index > 1 }}if (i === {{loop.index -1}}) value = vb.deserialize({{typeref(arg)}});
    {% endfor %}else throw new Error("Could not deserialize variant tag");
    return new {{class_name}}(value);
  }

  calcSerializedSize(): number {
    return 1 + this.value.calcSerializedSize();
  }

  typeToName(): string {
    {%- for arg in decl["tref"]["targs"] %}if (this.value instanceof {{typeref(arg)}})
      return "{{"::".join(arg["name"])}}";{% endfor %}
    throw new Error("Unknown variant type");
  }

  toJSON(): {{class_name}}Like {
    return {
      type: this.typeToName(),
      value: this.value.toJSON(),
    };
  }
}

export default {{class_name}};
